<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Port Arrivals</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin-bottom: 5px;
      padding: 5px;
      font-family: 'Open Sans', sans-serif;
    }
    h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    #chart {
      width: 100%;
      height: 600px; /* or use 100vh for full screen */
      margin: 0;
      padding: 0;
    }
    label, select {
      font-size: 14px;
      margin-right: 10px;
      font-family: 'Open Sans', sans-serif;
    }
  </style>
</head>
<body>


  <label for="countrySelect">Country:</label>
  <select id="countrySelect"></select>

  <label for="portSelect">Port:</label>
  <select id="portSelect"></select>

  <div id="chart" style="width:100%;height:100%;position:relative;"></div>
  

  <script>
    const hlCategories = ["Cargo", "Fishing", "Passenger", "Tanker"];
    let fullData = [];

    Papa.parse("https://raw.githubusercontent.com/cherrylchico/pacific-observatory-ais-data/main/data/monthly%20port%20calls.csv", {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        fullData = results.data.filter(d =>
          hlCategories.includes(d.HL) &&
          d["port call"] &&
          !isNaN(parseInt(d["port call"]))
        );
        populateCountryDropdown();
      }
    });

    function populateCountryDropdown() {
      const countries = [...new Set(fullData.map(d => d.Country))].sort();
      const countrySelect = document.getElementById("countrySelect");
      countrySelect.innerHTML = "";

      const allOption = document.createElement("option");
      allOption.value = "__ALL__";
      allOption.textContent = "All Countries";
      countrySelect.appendChild(allOption);

      countries.forEach(c => {
        const option = document.createElement("option");
        option.value = c;
        option.textContent = c;
        countrySelect.appendChild(option);
      });

      countrySelect.addEventListener("change", populatePortDropdown);
      countrySelect.value = "__ALL__";
      populatePortDropdown();
    }

    function populatePortDropdown() {
      const selectedCountry = document.getElementById("countrySelect").value;
      const portSelect = document.getElementById("portSelect");

      portSelect.innerHTML = "";

      const allOption = document.createElement("option");
      allOption.value = "__ALL__";
      allOption.textContent = "All Ports";
      portSelect.appendChild(allOption);

      if (selectedCountry === "__ALL__") {
        portSelect.disabled = true;
      } else {
        const ports = [...new Set(fullData.filter(d => d.Country === selectedCountry).map(d => d.Port))].sort();
        ports.forEach(p => {
          const option = document.createElement("option");
          option.value = p;
          option.textContent = p;
          portSelect.appendChild(option);
        });
        portSelect.disabled = false;
      }

      portSelect.addEventListener("change", updateChart);
      portSelect.value = "__ALL__";
      updateChart();
    }

    function updateChart() {
      const selectedCountry = document.getElementById("countrySelect").value;
      const selectedPort = document.getElementById("portSelect").value;

      let filtered = fullData.filter(d => hlCategories.includes(d.HL));

      if (selectedCountry !== "__ALL__") {
        filtered = filtered.filter(d => d.Country === selectedCountry);
        if (selectedPort !== "__ALL__") {
          filtered = filtered.filter(d => d.Port === selectedPort);
        }
      }

      const yearList = [...new Set(filtered.map(d => d.year))].sort();
      const allMonths = [];
      yearList.forEach(year => {
        for (let m = 1; m <= 12; m++) {
          allMonths.push({ year: year, month: m });
        }
      });

      const traces = hlCategories.map(hl => {
        const x = [];
        const y = [];

        allMonths.forEach(({ year, month }) => {
          const entries = filtered.filter(d =>
            d.year == year &&
            parseInt(d.month) == month &&
            d.HL === hl
          );
          const total = entries.reduce((sum, d) => sum + parseInt(d["port call"]), 0);
          if (total > 0) {
            x.push(`${year}-${month}`);
            y.push(total);
          }
        });

        return {
          x: x,
          y: y,
          name: hl,
          type: 'scatter',
          mode: 'lines'
        };
      });

      const layout = {
        autosize: true,
        margin: {
          l: 40,
          r: 20,
          t: 80,
          b: 50
        },
        title: {
          text: `<b>Monthly Port Arrivals - ${selectedPort === "__ALL__" ? "All Ports" : selectedPort}, ${selectedCountry === "__ALL__" ? "All Countries" : selectedCountry}</b>`,
          font: {
            family: 'Open Sans, sans-serif',
            size: 20
          }
        },
        yaxis: {
          showline:true,
          linecolor: '#ccc',
          griddash: 'dot',
          gridcolor: '#ccc',
          ticks: 'outside',
          tickcolor: '#ccc',
          zeroline: false
        },
        xaxis: {
          rangeslider: { visible: true},
          title: '',
          showgrid: false,
          ticks: 'outside',
          tickson: 'boundaries',
          tickcolor:'#ccc',
          showline: true,
          linecolor : '#ccc'
        },
        legend: {
          orientation: 'h',
          x: 0,
          y: 1,
        },
        hoverlabel:{
          font:{family: 'Open Sans, sans-serif'}
        },
      };

      Plotly.newPlot('chart', traces, layout, {responsive: true});

      const chartDiv = document.getElementById('chart');

// Create footer container
const footer = document.createElement('div');
footer.style.position = 'absolute';
footer.style.bottom = '0px';
footer.style.left = '0';
footer.style.width = '100%';
footer.style.display = 'flex';
footer.style.justifyContent = 'space-between';
footer.style.alignItems = 'center';
footer.style.padding = '10px 20px';
footer.style.fontFamily = 'Open Sans, sans-serif';
footer.style.fontSize = '14px';
footer.style.color = '#888';

// Add link
const link = document.createElement('div');
link.innerHTML = 'Source: <a href="https://www.worldbank.org" target="_blank" style="text-decoration: underline; color: #888;">World Bank Group</a>';
link.style.color = '#888';
link.style.fontFamily = 'Open Sans, sans-serif';
link.style.fontSize = '12px';


// Add logo
const logo = document.createElement('img');
logo.src = 'https://public.flourish.studio/uploads/71a85b0c-7f8c-453b-bc80-22b945333d58.png';
logo.style.height = '30px';
logo.style.objectFit = 'contain';
logo.style.marginRight = '5px';

// Append to footer
footer.appendChild(link);
footer.appendChild(logo);
chartDiv.appendChild(footer);

    }
  </script>
</body>
</html>